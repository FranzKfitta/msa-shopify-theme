{% comment %}
  The product template
{% endcomment %}

<main class="product-page">
  <div class="product-layout">
    <!-- Product Images -->
    <div class="product-gallery">
      {%- if product.images.size > 0 -%}
        {%- for image in product.images -%}
          <div class="product-media aspect-[3/4] overflow-hidden">
            <img
              src="{{ image | image_url: width: 800 }}"
              alt="{{ image.alt | escape }}"
              class="w-full h-full object-cover"
              loading="lazy"
              width="{{ image.width }}"
              height="{{ image.height }}"
            >
          </div>
        {%- endfor -%}
      {%- else -%}
        <div class="aspect-[3/4] overflow-hidden bg-secondary">
          {{ 'product-1.jpg' | asset_url | image_tag: loading: 'lazy', class: 'w-full h-full object-cover' }}
        </div>
      {%- endif -%}
    </div>

    <!-- Product Info -->
    <div class="product-details">
      <h1 class="product-title font-serif text-3xl md:text-4xl mb-4">{{ product.title }}</h1>
      <p class="product-price-main text-2xl mb-8">
        {{ product.price | money }}
        {%- if product.compare_at_price > product.price -%}
          <span class="line-through text-muted-foreground ml-2">{{ product.compare_at_price | money }}</span>
        {%- endif -%}
      </p>
      
      {%- if product.description != blank -%}
        <p class="text-muted-foreground mb-8 leading-relaxed">
          {{ product.description }}
        </p>
      {%- endif -%}

      <div class="border-t border-border mb-8"></div>

      <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" id="product-form">
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" id="product-variant-id">

        <!-- Variant Selection -->
        {%- unless product.has_only_default_variant -%}
          {%- for option in product.options_with_values -%}
            <div class="mb-8">
              <p class="font-medium mb-4">{{ option.name }}</p>
              <div class="flex gap-2 flex-wrap">
                {%- for value in option.values -%}
                  <button
                    type="button"
                    class="variant-option w-12 h-12 border transition-colors {% if option.selected_value == value %}border-foreground bg-foreground text-background{% else %}border-border hover:border-foreground{% endif %}"
                    data-option-name="{{ option.name }}"
                    data-option-value="{{ value }}"
                  >
                    {{ value }}
                  </button>
                {%- endfor -%}
              </div>
            </div>
          {%- endfor -%}
        {%- endunless -%}

        <!-- Quantity -->
        <div class="mb-8">
          <p class="font-medium mb-4">{{ 'products.product.quantity' | t }}</p>
          <div class="flex items-center gap-4">
            <button type="button" class="quantity-decrease w-10 h-10 border border-border hover:border-foreground transition-colors flex items-center justify-center">-</button>
            <input type="number" name="quantity" value="1" min="1" class="quantity-input w-12 text-center border-0" id="quantity">
            <button type="button" class="quantity-increase w-10 h-10 border border-border hover:border-foreground transition-colors flex items-center justify-center">+</button>
          </div>
        </div>

        <!-- Add to Bag -->
        <button type="submit" class="btn btn-default w-full mb-8 h-12" id="add-to-cart-button">
          {{ 'products.product.add_to_cart' | t }}
        </button>
      </form>

      <div class="border-t border-border mb-8"></div>

      <!-- Product Details -->
      {%- if product.metafields.custom.product_details != blank -%}
        <div>
          <p class="font-medium mb-4">{{ 'products.product.details' | t }}</p>
          <ul class="space-y-2 text-sm text-muted-foreground">
            {%- assign details = product.metafields.custom.product_details | split: ',' -%}
            {%- for detail in details -%}
              <li>â€¢ {{ detail | strip }}</li>
            {%- endfor -%}
          </ul>
        </div>
      {%- endif -%}
    </div>
  </div>
</main>
<style>
  .product-page {
    width: 100%;
    background-color: #ffffff;
  }

  .product-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    align-items: flex-start;
    position: relative;
  }

  @media (min-width: 1024px) {
    .product-layout {
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      column-gap: 4rem;
    }
  }

  .product-gallery {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .product-media {
    background: #ffffff;
  }

  @media (min-width: 1024px) {
    .product-details {
      padding: 4rem 6vw 4rem 3vw;
    }
  }

  .product-title {
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .product-price-main {
    font-weight: 500;
  }
</style>

<script>
  (function() {
    const details = document.querySelector('.product-details');
    const layout = document.querySelector('.product-layout');
    if (!details || !layout) return;

    const mq = window.matchMedia('(min-width: 768px)');
    let enabled = false;
    let start = 0;
    let end = 0;
    let headerOffset = 0;
    let detailsWidth = 0;
    let detailsLeft = 0;

    function getHeaderOffset() {
      const rootStyles = window.getComputedStyle(document.documentElement);
      const val = parseFloat(rootStyles.getPropertyValue('--header-offset'));
      if (!isNaN(val) && val > 0) return val;
      return 96; // fallback ~6rem
    }

    function resetDetails() {
      details.style.position = '';
      details.style.top = '';
      details.style.bottom = '';
      details.style.width = '';
      details.style.transform = '';
      details.style.left = '';
    }

    function onScroll() {
      if (!enabled) return;
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      if (scrollTop <= start) {
        // Before sticky zone
        resetDetails();
        details.style.position = 'relative';
      } else if (scrollTop >= end) {
        // After sticky zone - lock to bottom of layout
        resetDetails();
        details.style.position = 'absolute';
        details.style.bottom = '0';
        details.style.width = detailsWidth + 'px';
        details.style.left = detailsLeft + 'px';
      } else {
        // Within sticky zone - fixed under the header
        resetDetails();
        details.style.position = 'fixed';
        details.style.top = headerOffset + 'px';
        details.style.width = detailsWidth + 'px';
        details.style.left = detailsLeft + 'px';
      }
    }

    function updateBounds() {
      resetDetails();

      if (!mq.matches) {
        // Mobile: no sticky behavior
        enabled = false;
        window.removeEventListener('scroll', onScroll);
        return;
      }

      headerOffset = getHeaderOffset();

      const layoutRect = layout.getBoundingClientRect();
      const detailsRect = details.getBoundingClientRect();
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      const layoutTop = layoutRect.top + scrollTop;
      const layoutBottom = layoutTop + layout.offsetHeight;

      detailsWidth = detailsRect.width;
      detailsLeft = detailsRect.left;

      // Start sticky when top of details would pass under the header
      start = layoutTop - headerOffset;

      // End sticky when bottom of details would hit bottom of layout
      end = layoutBottom - details.offsetHeight - headerOffset;

      if (!enabled) {
        window.addEventListener('scroll', onScroll);
        enabled = true;
      }

      onScroll();
    }

    // Recalculate on load and when resizing
    window.addEventListener('load', updateBounds);
    window.addEventListener('resize', function() {
      // Use a small timeout to allow layout to settle
      window.setTimeout(updateBounds, 100);
    });

    // In case DOMContentLoaded fires after this script
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateBounds);
    } else {
      updateBounds();
    }
  })();
</script>
